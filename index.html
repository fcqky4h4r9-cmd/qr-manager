<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>QRç™»éŒ²ãƒ„ãƒ¼ãƒ«</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { margin: 6px 0; }
    .qr-box { display: inline-block; margin: 10px; text-align: center; }
  </style>
</head>

<body>

<h2>ğŸ“¦ ã‚¨ãƒŸãƒ³ã‚°æ§˜å°‚ç”¨ã€€QRç™»éŒ²ãƒ„ãƒ¼ãƒ«ï¼ˆGoogle Sheetsé€£æºï¼‰</h2>

<label>å“å:</label><br>
<input type="text" id="itemName"><br>

<label>ã‚«ãƒ†ã‚´ãƒª:</label><br>
<input type="text" id="category"><br>

<label>å‹ç•ª:</label><br>
<input type="text" id="model"><br>

<label>åˆæœŸé…ç½®:</label><br>
<input type="text" id="place"><br>

<button onclick="createAndUpload()">QRç”Ÿæˆï¼‹ç™»éŒ²</button>

<div id="status" style="margin-top:20px;"></div>
<div id="qrArea" style="margin-top:20px;"></div>

<script>
// ã‚ãªãŸã® WebApp ã® URL
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwOll1FpmZLjSFm7n61YszGv9YwZYRBOjBqmtdrT0P_LoXcs97nWtNKKiP73MqPhq7y/exec";

// UUIDç”Ÿæˆ
function uuid() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

async function createAndUpload() {
  const name = document.getElementById("itemName").value;
  const category = document.getElementById("category").value;
  const model = document.getElementById("model").value;
  const place = document.getElementById("place").value;

  if (!name) {
    alert("å“åã¯å¿…é ˆã§ã™");
    return;
  }

  const QRID = uuid();
  const payload = {
    QRID,
    name,
    model,
    category,
    place
  };

  document.getElementById("status").innerText = "é€ä¿¡ä¸­â€¦";

  try {
    // â˜… CORSåˆ¶é™å›é¿ã®ãŸã‚ no-cors ãƒ¢ãƒ¼ãƒ‰ã§é€ä¿¡
    await fetch(GAS_ENDPOINT, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    // ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã¯çµæœãŒè¦‹ãˆãªã„ã®ã§ã€Œé€ã£ãŸå‰æã€ã§æ‰±ã†
    document.getElementById("status").innerText =
      "é€ä¿¡å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚ã‚·ãƒ¼ãƒˆ(master)ã«è¡ŒãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚";

    // QRã‚’è¡¨ç¤º
    generateQR(QRID, name);

    // å…¥åŠ›æ¬„ã‚’è»½ããƒªã‚»ãƒƒãƒˆ
    // document.getElementById("itemName").value = "";
    // document.getElementById("model").value = "";
    // document.getElementById("category").value = "";
    // document.getElementById("place").value = "";

  } catch (err) {
    console.error("FETCH ERROR:", err);
    document.getElementById("status").innerText = "é€ä¿¡å¤±æ•—ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å´ã§é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼‰";
  }
}

function generateQR(id, name) {
  const text = `QRID=${id}`;

  const box = document.createElement("div");
  box.className = "qr-box";

  const label = document.createElement("div");
  label.innerText = name;

  const div = document.createElement("div");
  new QRCode(div, { text, width: 200, height: 200 });

  box.appendChild(label);
  box.appendChild(div);
  document.getElementById("qrArea").appendChild(box);
}
</script>

</body>
</html>
